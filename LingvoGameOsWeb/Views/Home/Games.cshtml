@model List<GameViewModel>

@{
    ViewData["Title"] = "Список игр";
}

<link rel="stylesheet" href="/css/games-page.css" />
<link rel="stylesheet" href="/css/modal-windows.css" />

<section class="games">
    @* <div class="games__filter-dropdowns">
        <div class="games__dropdown" style="max-width: 210px;">
            <button class="games__dropdown-toggle">
                <span>Платформа</span>
                <img src="/icon/chevron-down.svg" alt="Chevron" class="games__chevron">
            </button>
            <div class="games__dropdown-menu">
                <ul class="games__dropdown-list">
                    <li class="games__dropdown-item platform-filter" data-platform="">
                        <span class="filter-checkbox"></span>
                        Все платформы
                    </li>
                    <li class="games__dropdown-item platform-filter" data-platform="Web-Mobile">
                        <span class="filter-checkbox"></span>
                        Веб-мобильная
                    </li>
                    <li class="games__dropdown-item platform-filter" data-platform="Web-Desktop">
                        <span class="filter-checkbox"></span>
                        Веб-компьютерная
                    </li>
                    <li class="games__dropdown-item platform-filter" data-platform="Desktop">
                        <span class="filter-checkbox"></span>
                        Для скачивания
                    </li>
                </ul>
            </div>
        </div>
    </div> *@

    <div class="games__filter">
        @* @using (Html.AjaxBeginForm("Search", "Home", new AjaxOptions
        {
            HttpMethod = "get",
            UpdateTargetId = "all-games",
            LoadingElementId = "search-loading"
        }))
        {
            <div class="games__filter-search">
                @if (ViewBag.GameName != null)
                {
                    <input type="text" name="gameName" id="search-input" required value="@ViewBag.GameName" class="email-prompt-text-style games__search-input"
                           placeholder="Найти игру...">
                }
                else
                {
                    <input type="text" name="gameName" id="search-input" required class="email-prompt-text-style games__search-input" placeholder="Найти игру..." />
                }

                <button type="submit" class="games__search-button">Найти</button>
                <button type="button" onclick="resetGamesList()" class="games__search-button">Сброс</button>
            </div>
        }

        <!-- Индикатор активных фильтров -->
        <div id="active-filters" class="games__active-filters" style="display: none;">
            <span class="games__active-filters-label">Активные фильтры:</span>
            <div id="active-filters-list" class="games__active-filters-list"></div>
            <button type="button" onclick="clearAllFilters()" class="games__clear-filters-btn">Очистить все</button>
        </div> *@

        <div class="games__filter-dropdowns">
            <div class="games__dropdown" style="max-width: 240px;">
                <button class="games__dropdown-toggle">
                    <span>Платформа</span>
                    <img src="/icon/chevron-down.svg" alt="Chevron" class="games__chevron">
                </button>
                <div class="games__dropdown-menu">
                    <ul class="games__dropdown-list">
                        <li class="games__dropdown-item platform-filter" data-platform="">
                            <span class="filter-checkbox"></span>
                            Все платформы
                        </li>
                        <li class="games__dropdown-item platform-filter" data-platform="Web-Mobile">
                            <span class="filter-checkbox"></span>
                            Веб-мобильная
                        </li>
                        <li class="games__dropdown-item platform-filter" data-platform="Web-Desktop">
                            <span class="filter-checkbox"></span>
                            Веб-компьютерная
                        </li>
                        <li class="games__dropdown-item platform-filter" data-platform="Desktop">
                            <span class="filter-checkbox"></span>
                            Для скачивания
                        </li>
                    </ul>
                </div>
            </div>
            @* <div class="games__dropdown">
                <button class="games__dropdown-toggle">
                    <span>Категории</span>
                    <img src="/icon/chevron-down.svg" alt="Chevron" class="games__chevron">
                </button>
                <div class="games__dropdown-menu">
                    <div class="games__dropdown-search">
                        <input type="text" class="games__dropdown-search-input" placeholder="Поиск...">
                    </div>
                    <ul class="games__dropdown-list">
                        @foreach (var skill in ViewBag.SkillsLearning)
                        {
                            <li class="games__dropdown-item" data-filter="category" data-value="@skill.ToLower()">
                                @skill
                            </li>
                        }
                    </ul>
                </div>
            </div>
            <div class="games__dropdown">
                <button class="games__dropdown-toggle">
                    <span>Ключевые слова</span>
                    <img src="/icon/chevron-down.svg" alt="Chevron" class="games__chevron">
                </button>
                <div class="games__dropdown-menu">
                    <div class="games__dropdown-search">
                        <input type="text" class="games__dropdown-search-input" placeholder="Поиск...">
                    </div>
                    <ul class="games__dropdown-list">
                        <li class="games__dropdown-item" data-filter="keyword" data-value="культура">
                            Культура
                        </li>
                        <li class="games__dropdown-item" data-filter="keyword" data-value="история">
                            История
                        </li>
                        <li class="games__dropdown-item" data-filter="keyword" data-value="язык">
                            Язык
                        </li>
                    </ul>
                </div>
            </div>
            <div class="games__dropdown">
                <button class="games__dropdown-toggle">
                    <span>Рейтинг</span>
                    <img src="/icon/chevron-down.svg" alt="Chevron" class="games__chevron">
                </button>
                <div class="games__dropdown-menu">
                    <ul class="games__dropdown-list">
                        <li class="games__dropdown-item" data-filter="rating" data-value="5">
                            <img src="/icon/star.svg" alt="Star" class="rating-star filled"> 5
                        </li>
                        <li class="games__dropdown-item" data-filter="rating" data-value="4">
                            <img src="/icon/star.svg" alt="Star" class="rating-star filled"> 4
                        </li>
                        <li class="games__dropdown-item" data-filter="rating" data-value="3">
                            <img src="/icon/star.svg" alt="Star" class="rating-star filled"> 3
                        </li>
                    </ul>
                </div>
            </div> *@
        </div>
    </div>

    @if (ViewBag.GameName != null)
    {
        <!-- Это сейчас не отображается, не работает-->
        <h2 class="games__title">Игры по запросу: @ViewBag.GameName</h2>
    }
    else
    {
        <h2 class="games__title">Все игры</h2>
    }

    <!-- Индикатор загрузки -->
    <div id="search-loading" style="display: none; margin: 20px 0;">
        <!-- Тут хотелось бы спинер загрузки-->
        @* <div role="status">
                <span">Загрузка...</span>
            </div> *@
        <p class="game-play__loading-text">Идет поиск игр...</p>
    </div>

    <div class="games__list" id="all-games">
        @if (Model != null && Model.Any())
        {
            @foreach (var game in Model)
            {
                @if (game.IsActive)
                {
                    <div class="games__item"
                         data-rating="@game.AverageRaitingPlayers"
                         data-platform="@game?.GamePlatform?.Name"
                         data-categories="@(game.SkillsLearning != null ? string.Join(",", game.SkillsLearning.Select(s => s.Name.ToLower())) : "")"
                         data-keywords="@(game.SkillsLearning != null ? string.Join(",", game.SkillsLearning.Select(s => s.Name.ToLower())) : "")">

                        <!-- Кнопка добавления в избранное -->
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <button class="games__favorite-btn @(game.IsFavorite ? "active" : "")"
                                    data-game-id="@game.Id">
                                <img src="@(game.IsFavorite ? "/icon/like2.svg" : "/icon/like.svg")"
                                     alt="Добавить в избранное"
                                     class="games__favorite-icon">
                            </button>
                        }
                        else
                        {
                            <a role="button" asp-area="" asp-controller="Account" asp-action="Login" class="games__favorite-btn">
                                <img src="/icon/like.svg"
                                     alt="Добавить в избранное"
                                     class="games__favorite-icon">
                            </a>
                        }

                        <img class="games__image" src="@game.CoverImagePath" alt="@game.Title">
                        <div class="games__content">
                            <h3 class="games__name">@game.Title</h3>
                            <div class="games__stats">
                                <span class="games__rating">
                                    <img src="/icon/star.svg" alt="star" class="rating-star filled"> @game.AverageRaitingPlayers
                                </span>
                                <span class="games__likes">
                                    <img src="/icon/like2.svg" alt="like" class="stat-icon favorite-toggle"> @game.FavoritesCount
                                </span>
                                @* <span class="games__views">
                                <img src="/icon/eye.svg" alt="view" class="stat-icon"> @game.NumberDownloads
                            </span> *@
                            </div>
                            <div class="games__actions">
                                @if (game?.GamePlatform?.Name == "Desktop")
                                {
                                    <a href="@game.GameFilePath" download role="button" class="games__button download-btn">Скачать</a>
                                }
                                else
                                {
                                    <a asp-controller="Game" asp-action="Start" asp-route-idGame="@game.Id" class="games__button">Играть</a>
                                }
                                <a asp-controller="Game" asp-action="Details" asp-route-idGame="@game.Id" role="button" class="games__preview button">Подробнее</a>
                            </div>
                        </div>
                    </div>
                }
            }
        }
    </div>
</section>

<!-- Модальное окно подтверждения скачивания -->
<div id="downloadModal" class="modal download-modal" style="display: none;">
    <div class="modal__content download-modal__content">
        <button class="modal__close download-modal__close" type="button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>

        <div class="download-modal__header">
            <h3 class="download-modal__title">Подтверждение скачивания</h3>
        </div>

        <div class="download-modal__body">
            <div class="download-modal__icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="var(--accent-2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M7 10L12 15L17 10" stroke="var(--accent-2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 15V3" stroke="var(--accent-2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <p class="download-modal__message">Вы собираетесь скачать игру, которую можно запустить только на компьютере. Продолжить?</p>
        </div>

        <div class="download-modal__footer">
            <button type="button" class="download-modal__cancel games__preview">Отмена</button>
            <button type="button" class="download-modal__confirm games__button">Скачать</button>
        </div>
    </div>
</div>

<script src="/js/download-handler.js"></script>
@section Scripts {
    <script>
        // Глобальная переменная для хранения выбранной платформы
        let selectedPlatform = '';

        // Функция фильтрации по платформе
        function filterByPlatform(platform) {
            // Показываем индикатор загрузки
            $('#search-loading').show();

            // Обновляем выбранную платформу
            selectedPlatform = platform;

            // Отправляем AJAX запрос
            $.ajax({
                url: '@Url.Action("FilterGames", "Home")',
                type: 'GET',
                data: {
                    platform: platform,
                    // Можно добавить другие фильтры, если они есть
                    rating: getSelectedRating(),
                    category: getSelectedCategory(),
                    keyword: getSelectedKeyword()
                },
                success: function(data) {
                    $('#all-games').html(data);

                    // Обновляем UI выбранной платформы
                    updatePlatformUI(platform);

                    // Обновляем активные фильтры
                    updateActiveFilters();
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка фильтрации:', error);
                    showNotification('Ошибка при фильтрации игр', 'error');
                },
                complete: function() {
                    $('#search-loading').hide();
                }
            });
        }

        // Функция обновления UI для выбранной платформы
        function updatePlatformUI(selectedPlatform) {
            // Убираем выделение со всех элементов платформы
            document.querySelectorAll('.platform-filter').forEach(item => {
                item.classList.remove('selected');
                const checkbox = item.querySelector('.filter-checkbox');
                if (checkbox) {
                    checkbox.classList.remove('checked');
                }
            });

            // Находим выбранный элемент и добавляем выделение
            const selectedItem = document.querySelector(`.platform-filter[data-platform="${selectedPlatform}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
                const checkbox = selectedItem.querySelector('.filter-checkbox');
                if (checkbox) {
                    checkbox.classList.add('checked');
                }

                // Обновляем текст кнопки
                updateDropdownButtonText(selectedItem);
            }
        }

        // Функция обновления текста кнопки dropdown
        function updateDropdownButtonText(selectedItem) {
            const button = document.querySelector('.games__dropdown-toggle');
            if (!button) return;

            // Получаем чистый текст без лишних элементов
            const platformText = selectedItem.textContent.trim();

            // Очищаем содержимое кнопки
            button.innerHTML = '';

            if (selectedPlatform === '') {
                button.innerHTML = '<span>Платформа</span><img src="/icon/chevron-down.svg" alt="Chevron" class="games__chevron">';
            } else {
                const span = document.createElement('span');
                span.textContent = platformText;

                button.appendChild(span);

                const chevron = document.createElement('img');
                chevron.src = '/icon/chevron-down.svg';
                chevron.alt = 'Chevron';
                chevron.className = 'games__chevron';
                button.appendChild(chevron);
            }
        }

        // Функция обновления активных фильтров
        function updateActiveFilters() {
            const activeFiltersContainer = document.getElementById('active-filters');
            const activeFiltersList = document.getElementById('active-filters-list');

            if (!activeFiltersContainer || !activeFiltersList) return;

            activeFiltersList.innerHTML = '';

            // Маппинг русских названий
            const platformNames = {
                'Web-Mobile': 'Веб-мобильная',
                'Web-Desktop': 'Веб-компьютерная',
                'Desktop': 'Для скачивания'
            };

            // Добавляем фильтр платформы, если выбран
            if (selectedPlatform) {
                const filterElement = document.createElement('div');
                filterElement.className = 'games__active-filter';
                filterElement.dataset.filterType = 'platform';
                filterElement.dataset.filterValue = selectedPlatform;

                const displayValue = platformNames[selectedPlatform] || selectedPlatform;

                filterElement.innerHTML = `
                    <span class="games__active-filter-text">
                        Платформа: ${displayValue}
                    </span>
                    <button class="games__active-filter-remove"
                            onclick="clearPlatformFilter()">
                        ×
                    </button>
                `;

                activeFiltersList.appendChild(filterElement);
            }

            // Показываем/скрываем контейнер активных фильтров
            const hasActiveFilters = selectedPlatform ||
                                    getSelectedRating() ||
                                    getSelectedCategory() ||
                                    getSelectedKeyword();

            activeFiltersContainer.style.display = hasActiveFilters ? 'block' : 'none';
        }

        // Функция сброса фильтра платформы
        function clearPlatformFilter() {
            selectedPlatform = '';
            filterByPlatform('');
            showNotification('Фильтр платформы сброшен', 'info');
        }

        // Функция сброса всех фильтров
        function clearAllFilters() {
            selectedPlatform = '';

            // Сбрасываем другие фильтры
            document.querySelectorAll('.games__dropdown-item.selected').forEach(item => {
                if (!item.classList.contains('platform-filter')) {
                    item.classList.remove('selected');
                }
            });

            // Сбрасываем UI платформы
            updatePlatformUI('');

            // Вызываем фильтрацию без параметров
            filterByPlatform('');

            showNotification('Все фильтры очищены', 'info');
        }

        // Инициализация обработчиков при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Находим все элементы фильтра платформы
            const platformItems = document.querySelectorAll('.platform-filter');

            // Добавляем обработчик клика
            platformItems.forEach(item => {
                item.addEventListener('click', function() {
                    const platform = this.dataset.platform;

                    // Если кликнули на уже выбранную платформу - сбрасываем
                    if (selectedPlatform === platform) {
                        clearPlatformFilter();
                    } else {
                        filterByPlatform(platform);
                    }

                    // Закрываем dropdown после выбора
                    const dropdownMenu = this.closest('.games__dropdown-menu');
                    if (dropdownMenu) {
                        dropdownMenu.classList.remove('show');
                    }
                });
            });

            // Закрытие dropdown при клике вне его
            document.addEventListener('click', function(event) {
                const dropdowns = document.querySelectorAll('.games__dropdown');
                dropdowns.forEach(dropdown => {
                    if (!dropdown.contains(event.target)) {
                        const menu = dropdown.querySelector('.games__dropdown-menu');
                        if (menu) {
                            menu.classList.remove('show');
                        }
                    }
                });
            });

            // Обработчик для кнопки открытия/закрытия dropdown
            const dropdownToggle = document.querySelector('.games__dropdown-toggle');
            if (dropdownToggle) {
                dropdownToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const menu = this.nextElementSibling;
                    if (menu) {
                        menu.classList.toggle('show');
                    }
                });
            }
        });

        // Вспомогательные функции для других фильтров (если есть)
        function getSelectedRating() {
            const selected = document.querySelector('.games__dropdown-item.selected[data-filter="rating"]');
            return selected ? selected.dataset.value : null;
        }

        function getSelectedCategory() {
            const selected = document.querySelector('.games__dropdown-item.selected[data-filter="category"]');
            return selected ? selected.dataset.value : null;
        }

        function getSelectedKeyword() {
            const selected = document.querySelector('.games__dropdown-item.selected[data-filter="keyword"]');
            return selected ? selected.dataset.value : null;
        }

        // Остальные функции
        function resetGamesList() {
            $('#search-input').val('');
            $('#all-games').load('@Url.Action("FullGamesList", "Home")');
        }

        function showNotification(message, type) {
            let notification = document.querySelector('.notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    max-width: 300px;
                `;
                document.body.appendChild(notification);
            }

            notification.textContent = message;
            notification.className = `notification notification--${type}`;
            notification.style.display = 'block';
            notification.style.opacity = '1';

            setTimeout(function() {
                notification.style.opacity = '0';
                setTimeout(function() {
                    notification.style.display = 'none';
                }, 300);
            }, 3000);
        }
    </script>
}