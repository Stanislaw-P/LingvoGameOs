@model UserViewModel

@{
    ViewData["Title"] = $"Профиль {Model.Name} {Model.Surname}";
}

<link rel="stylesheet" href="/css/modal-windows.css" />

<div class="content__row">
    <aside class="content__sidebar">
        <!-- Профиль пользователя -->
        <div class="profile">
            <h3 class="profile__title">Профиль пользователя</h3>
            <div class="profile__avatar">
                <div class="profile__avatar-wrapper">
                    <img src="@Model.AvatarImgPath" alt="Аватар пользователя" class="profile__image">
                </div>
            </div>
            <form class="profile__form">
                <div class="profile__field">
                    <label class="profile__label" for="firstName">Имя</label>
                    <input type="text" class="profile__input" id="firstName" value="@Model.Name" disabled>
                </div>
                <div class="profile__field">
                    <label class="profile__label" for="lastName">Фамилия</label>
                    <input type="text" class="profile__input" id="lastName" value="@Model.Surname" disabled>
                </div>
                <div class="profile__field">
                    <label class="profile__label" for="email">Email</label>
                    <input type="email" class="profile__input" id="email" value="@Model.UserName" disabled>
                </div>
                <div class="profile__field profile__field--bio">
                    <label class="profile__label" for="bio">О себе</label>
                    <textarea class="profile__input profile__textarea" id="bio" placeholder="Расскажите о себе" disabled>@Model.Description</textarea>
                </div>
                @if (Model.IsMyProfile)
                {
                    <a type="button" class="profile__button" asp-controller="Profile" asp-action="Settings" asp-route-userId="@Model.Id">
                        Изменить профиль
                    </a>
                }
            </form>
        </div>
    </aside>
    <section class="content__main">
        <!-- Блок добавленных пользователем игр -->
        <div class="games-block">
            <!-- Блок добавленных пользователем игр -->
            <section class="user-added-games">
                <header class="user-added-games__header">
                    <h3 class="user-added-games__title">Созданные игры</h3>
                    <div class="user-added-games__controls">
                        @if (Model.IsMyProfile)
                        {
                            <a type="button" class="user-added-games__upload-button" asp-controller="Game" asp-action="Upload">Загрузить игру</a>
                        }
                        @if (Model.DevGames != null && Model.DevGames.Any())
                        {
                            <div class="carousel-controls">
                                <button class="carousel-control carousel-control--prev user-added-games__prev" aria-label="Предыдущие игры">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="15 18 9 12 15 6"></polyline>
                                    </svg>
                                </button>
                                <span class="carousel-page-counter user-added-games__page-counter">1 из 1</span>
                                <button class="carousel-control carousel-control--next user-added-games__next" aria-label="Следующие игры">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                        }
                    </div>
                </header>
                @if ((Model.DevGames != null && Model.DevGames.Any()) || (Model.DevPendingGames != null && Model.DevPendingGames.Any()))
                {
                    <div class="user-added-games__carousel">
                        <div class="user-added-games__list">
                            @foreach (var game in Model.DevGames!)
                            {
                                <article class="user-added-games__item">
                                    <a asp-area="" asp-controller="Game" asp-action="Details" asp-route-idGame="@game.Id" class="user-added-games__link">
                                        <img src="@(game.CoverImagePath ?? "/img/default-game.png")" alt="Обложка @game.Title" class="user-added-games__image" loading="lazy">
                                        <div class="user-added-games__content">
                                            <h4 class="user-added-games__name">@game.Title</h4>
                                            <div class="user-added-games__stats">
                                                <span class="user-added-games__rating">
                                                    <img src="/icon/shape.svg" alt="star" class="rating-star"> @game.RaitingPlayers
                                                </span>
                                                <span class="user-added-games__likes">
                                                    <img src="/icon/like2.svg" alt="like" class="stat-icon"> @game.FavoritesCount
                                                </span>
                                                @* <span class="user-added-games__views">
                                                    <img src="/icon/eye.svg" alt="view" class="stat-icon"> 130
                                                </span> *@
                                            </div>
                                        </div>
                                    </a>
                                    <div class="user-added-games__actions">
                                        @if (game.GamePlatform.Name == "Desktop")
                                        {
                                            <a role="button" href="@game.GameFilePath" download class="user-added-games__button download-btn">Скачать</a>
                                        }
                                        else
                                        {
                                            <a role="button" asp-area="" asp-controller="Game" asp-action="Start" asp-route-idGame="@game.Id" class="user-added-games__button">Играть</a>
                                        }
                                        @if (Model.IsMyProfile)
                                        {
                                            <a href="#" class="user-added-games__button user-added-games__button--secondary">Аналитика</a>
                                            <a href="#" class="user-added-games__button user-added-games__button--icon" title="Редактировать">
                                                <img src="/icon/edit.svg" alt="Редактировать" class="user-added-games__edit-icon">
                                            </a>
                                        }
                                    </div>
                                </article>
                            }
                            @if (Model.IsMyProfile)
                            {
                                @foreach (var pendingGame in Model.DevPendingGames!)
                                {
                                    <article class="user-added-games__item">
                                        <div class="user-added-games__link">
                                            <img src="@(pendingGame.CoverImagePath ?? "/img/default-game.png")" alt="Обложка @pendingGame.Title" class="user-added-games__image" loading="lazy">
                                            <div class="pending-game-card__status">На модерации</div>
                                            <div class="user-added-games__content">
                                                <h4 class="user-added-games__name">@pendingGame.Title</h4>
                                            </div>
                                        </div>
                                        <div class="user-added-games__actions">
                                            @if (pendingGame.GamePlatform.Name == "Desktop")
                                            {
                                                <a role="button" href="@pendingGame.GameURL" download class="user-added-games__button">Скачать</a>
                                            }
                                            else
                                            {
                                                <button disabled class="user-added-games__button">На модерации</button>
                                            }
                                            @if (Model.IsMyProfile)
                                            {
                                                <a href="#" class="user-added-games__button user-added-games__button--secondary">Аналитика</a>
                                                <a href="#" class="user-added-games__button user-added-games__button--icon" title="Редактировать">
                                                    <img src="/icon/edit.svg" alt="Редактировать" class="user-added-games__edit-icon">
                                                </a>
                                            }
                                        </div>
                                    </article>
                                }
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="user-added-games__empty">
                        <p class="user-added-games__empty-text">Создайте свою первую игру!</p>
                        @if (User.IsInRole(Constants.DevRoleName))
                        {
                            <a type="button" asp-area="" asp-controller="Game" asp-action="Upload" class="user-added-games__upload-button">Создать игру</a>
                        }
                    </div>
                }
            </section>

            <!-- Recent Games Block -->
            <section class="recent-games">
                <header class="recent-games__header">
                    <h3 class="recent-games__title">Все игры</h3>
                    <div class="recent-games__controls">
                        <a href="/Home/Games/" class="recent-games__view-all-button">Посмотреть все</a>
                        @{
                            var placeholderGames = ViewBag.AllGames;

                        }
                        @if (ViewBag.AllGames != null)
                        {
                            <div class="carousel-controls">
                                <button class="carousel-control carousel-control--prev recent-games__prev" aria-label="Предыдущие игры">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="15 18 9 12 15 6"></polyline>
                                    </svg>
                                </button>
                                <span class="carousel-page-counter recent-games__page-counter">1 из 1</span>
                                <button class="carousel-control carousel-control--next recent-games__next" aria-label="Следующие игры">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                        }
                    </div>
                </header>
                @if (placeholderGames != null)
                {
                    <div class="recent-games__carousel">
                        <div class="recent-games__list">
                            @foreach (var game in placeholderGames)
                            {
                                <article class="recent-games__item">
                                    <a asp-area="" asp-controller="Game" asp-action="Details" asp-route-idGame="@game.Id" class="recent-games__link">
                                        <img src="@game.CoverImagePath" alt="Обложка @game.Title" class="recent-games__image" loading="lazy">
                                        <div class="recent-games__content">
                                            <h4 class="recent-games__name">@game.Title</h4>
                                            <p class="recent-games__description">@game.Description</p>
                                            <p class="recent-games__score">Баллы: 0</p>
                                        </div>
                                    </a>
                                </article>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="recent-games__empty">
                        <p class="recent-games__empty-text">Откройте новые игры для изучения!</p>
                        <a href="/games" class="recent-games__button">Найти игры</a>
                    </div>
                }
            </section>
        </div>
    </section>
</div>

<!-- Modal for editing profile -->
<div class="custom-modal" id="edit-profile-modal">
    <div class="modal__content">
        <button class="modal__close" id="close-edit-modal" aria-label="Закрыть модальное окно">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <h2 class="modal__title">Редактировать профиль</h2>
        <form class="modal__form" id="edit-profile-form" enctype="multipart/form-data">
            <div class="modal__field">
                <label class="modal__label" for="modal-avatar">Аватар</label>
                <div class="modal__avatar-wrapper">
                    <img src="@(Model.AvatarImgPath ?? "/img/avatar100.png")" alt="Аватар пользователя" class="modal__avatar-image" id="modal-avatar-preview">
                    <input type="file" class="modal__avatar-input" id="modal-avatar" accept="image/*">
                    <label for="modal-avatar" class="modal__upload-button">Загрузить новое фото</label>
                </div>
            </div>
            <div class="modal__field">
                <label class="modal__label" for="modal-firstName">Имя</label>
                <input type="text" class="modal__input" id="modal-firstName" value="@Model.Name" required>
            </div>
            <div class="modal__field">
                <label class="modal__label" for="modal-lastName">Фамилия</label>
                <input type="text" class="modal__input" id="modal-lastName" value="@Model.Surname" required>
            </div>
            <div class="modal__field">
                <label class="modal__label" for="modal-email">Email</label>
                <input type="email" class="modal__input" id="modal-email" value="@Model.UserName" required>
            </div>
            <div class="modal__field">
                <label class="modal__label" for="modal-bio">О себе</label>
                <textarea class="modal__input modal__textarea" id="modal-bio" placeholder="Расскажите о себе">@Model.Description</textarea>
            </div>
            <div class="modal__actions">
                <button type="button" class="modal__button modal__button--secondary" id="cancel-edit">Отмена</button>
                <button type="submit" class="modal__button modal__button--primary" id="save-profile">Сохранить</button>
            </div>
            <div class="modal__error" id="modal-error" style="display: none;"></div>
        </form>
    </div>
</div>

<!-- Модальное окно подтверждения скачивания -->
<div id="downloadModal" class="modal download-modal" style="display: none;">
    <div class="modal__content download-modal__content">
        <button class="modal__close download-modal__close" type="button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>

        <div class="download-modal__header">
            <h3 class="download-modal__title">Подтверждение скачивания</h3>
        </div>

        <div class="download-modal__body">
            <div class="download-modal__icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="var(--accent-2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M7 10L12 15L17 10" stroke="var(--accent-2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 15V3" stroke="var(--accent-2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <p class="download-modal__message">Вы собираетесь скачать файл игры, которую можно запустить только на компьютере. Продолжить?</p>
        </div>

        <div class="download-modal__footer">
            <button type="button" class="download-modal__cancel games__preview">Отмена</button>
            <button type="button" class="download-modal__confirm games__button">Скачать</button>
        </div>
    </div>
</div>

@* <script type="module" src="/js/script.js"></script> *@
<script src="/js/download-handler.js"></script>