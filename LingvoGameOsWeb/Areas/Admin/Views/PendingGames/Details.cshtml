@model EditGameViewModel

@{
    ViewData["Title"] = $"Детали игры: {Model.Title}";
}

<div class="wrapper">
    <div id="header-placeholder"></div>
    <main class="content">
        <div class="content__container _container">
            <section class="upload-hero" data-game-id="upload">
                <div class="upload-hero__content">
                    <h1 class="upload-hero__title">Загрузить игру</h1>
                    <div class="upload-hero__form-container">
                        <p class="upload-hero__info">
                            Ознакомьтесь с нашими
                            <a href="#" id="open-quality-modal" class="upload-hero__info--highlight">
                                рекомендациями по обеспечению качества
                            </a>
                            перед публикацией вашего проекта.
                        </p>
                        <form method="post" class="upload-form" id="upload-game-form" data-action="/admin/pendingGame/details" enctype="multipart/form-data">
                            <div asp-validation-summary="All" style="color:red"></div>

                            <div class="upload-form__group">
                                <label class="upload-form__label">
                                    Автор игры <span class="required">*</span>
                                </label>
                                <div class="upload-form__input-wrapper">
                                    <div class="input-field">
                                        <input type="text" value="@Model.Author.Name @Model.Author.Surname" class="input-field__input"
                                               readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="upload-form__group">
                                <label class="upload-form__label">
                                    Дата отправки заявки <span class="required">*</span>
                                </label>
                                <div class="upload-form__input-wrapper">
                                    <div class="input-field">
                                        <input type="text" value="@Model.DispatchDate.ToString("dd.MM.yyyy")" class="input-field__input"
                                               readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="upload-form__group">
                                <label for="game-title" class="upload-form__label">
                                    Название игры <span class="required">*</span>
                                </label>
                                <div class="upload-form__input-wrapper">
                                    <div class="input-field">
                                        <input type="text" asp-for="Title" id="game-title" name="title" class="input-field__input"
                                               placeholder="Введите название игры" required>
                                    </div>
                                    <span id="title-error" class="error-message"></span>
                                </div>
                            </div>

                            <div class="upload-form__group">
                                <label for="game-short-description" class="upload-form__label">
                                    Краткое описание игры
                                    (до 200 символов) <span class="required">*</span>
                                </label>
                                <div class="upload-form__input-wrapper">
                                    <div class="input-field input-field--textarea">
                                        <textarea asp-for="Description" id="game-short-description" name="description"
                                                  class="input-field__textarea"
                                                  placeholder="Кратко опишите сюжет или суть игры" maxlength="200"
                                                  required></textarea>
                                    </div>
                                    <span id="short-description-error" class="error-message"></span>
                                </div>
                            </div>

                            <div class="upload-form__group">
                                <label for="game-rules" class="upload-form__label">
                                    Правила игры <span class="required">*</span>
                                </label>
                                <div class="upload-form__input-wrapper">
                                    <div class="input-field input-field--textarea">
                                        <textarea asp-for="Rules" id="game-rules" name="rules" class="input-field__textarea"
                                                  placeholder="Опишите правила игры" required></textarea>
                                    </div>
                                    <span id="rules-error" class="error-message"></span>
                                </div>
                            </div>

                            <div class="upload-form__group">
                                <label for="game-skillsLearning" class="upload-form__label">
                                    Развиваемые навыки <span class="required">*</span>
                                </label>
                                <div class="upload-form__input-wrapper" data-tooltip="Выберите развиваемые навыки, соответствующие вашей игре">
                                    <div class="custom-dropdown" id="skillsLearning-dropdown">
                                        <div class="custom-dropdown__selected" tabindex="0" role="combobox" aria-expanded="false" aria-label="Выберите развиваемые навыки">
                                            <span class="custom-dropdown__placeholder">Выберите развиваемые навыки</span>
                                            <img src="/icon/chevron-down.svg" alt="Открыть список" class="custom-dropdown__icon">
                                        </div>
                                        <div class="custom-dropdown__menu" role="listbox" aria-hidden="true">
                                            <input type="text" class="custom-dropdown__search" placeholder="Поиск навыков..." aria-label="Поиск навыков">
                                            <ul class="custom-dropdown__options">
                                                <li class="custom-dropdown__option" data-value="select-all" role="option" aria-selected="false">Выбрать все</li>
                                                @foreach (var skill in ViewBag.SkillsLearning)
                                                {
                                                    <li class="custom-dropdown__option" data-value="@skill" role="option" aria-selected="false">@skill</li>
                                                }
                                            </ul>
                                        </div>
                                        <div class="selected-skillsLearning-list" id="selected-skillsLearning-list">
                                            @if (Model.SkillsLearning != null && Model.SkillsLearning.Any())
                                            {
                                                @foreach (var skillName in Model.SkillsLearning)
                                                {
                                                    <span class="selected-item" data-value="@skillName">
                                                        @skillName
                                                        <span class="selected-item__remove" role="button" aria-label="Удалить @skillName">×</span>
                                                    </span>
                                                }
                                            }
                                        </div>
                                        <input asp-for="SkillsLearning" type="hidden" id="game-skillsLearning" name="skillsLearning" value="@(Model.SkillsLearning != null ? string.Join(",", Model.SkillsLearning) : "")" required>
                                    </div>
                                    <span id="skillsLearning-error" class="error-message"></span>
                                </div>
                            </div>

                            <div class="upload-form__group">
                                <label class="upload-form__label">Уровень <span class="required">*</span></label>
                                <div class="upload-form__input-wrapper">
                                    <div class="level-list">
                                        <label class="level-item">
                                            <span class="level-item__input">
                                                <input type="radio" asp-for="LanguageLevel" name="LanguageLevel" value="Барашек, который пытается говорить"
                                                       class="level-item__radio" required>
                                            </span>
                                            <span class="level-item__text">
                                                «Барашек, который пытается говорить» –
                                                начинаешь издавать осмысленные звуки, но пока не всё понятно.
                                            </span>
                                        </label>
                                        <label class="level-item">
                                            <span class="level-item__input">
                                                <input type="radio" asp-for="LanguageLevel" name="LanguageLevel" value="Юный нарт"
                                                       class="level-item__radio">
                                            </span>
                                            <span class="level-item__text">
                                                «Юный нарт» – уже умеешь составлять
                                                предложения и понимаешь базовые правила языка.
                                            </span>
                                        </label>
                                        <label class="level-item">
                                            <span class="level-item__input">
                                                <input type="radio" asp-for="LanguageLevel" name="LanguageLevel" value="Кавказский орёл"
                                                       class="level-item__radio">
                                            </span>
                                            <span class="level-item__text">
                                                «Кавказский орёл» – уверенно говоришь,
                                                строишь сложные фразы и можешь поддержать разговор.
                                            </span>
                                        </label>
                                        <label class="level-item">
                                            <span class="level-item__input">
                                                <input type="radio" asp-for="LanguageLevel" name="LanguageLevel" value="Старейшина, который говорит тосты"
                                                       class="level-item__radio">
                                            </span>
                                            <span class="level-item__text">
                                                «Старейшина, который говорит тосты» –
                                                свободно владеешь языком, понимаешь тонкости и культурные
                                                нюансы.
                                            </span>
                                        </label>
                                        <label class="level-item">
                                            <span class="level-item__input">
                                                <input type="radio" asp-for="LanguageLevel" name="LanguageLevel" value="Хранитель языка"
                                                       class="level-item__radio">
                                            </span>
                                            <span class="level-item__text">
                                                «Хранитель языка» – ты достиг вершины мастерства, твой язык – как песня гор, а слова – как мудрость веков.
                                            </span>
                                        </label>
                                    </div>
                                    <span id="level-error" class="error-message"></span>
                                </div>
                            </div>

                            <div class="upload-form__group">
                                <label for="game-platform" class="upload-form__label">
                                    Платформа <span class="required">*</span>
                                </label>
                                <div class="upload-form__input-wrapper" data-tooltip="Выберите платформу для вашей игры">
                                    <div class="custom-dropdown" id="platform-dropdown">
                                        <input type="hidden" asp-for="GamePlatform" id="game-platform" name="GamePlatform" required>
                                        <div class="custom-dropdown__selected" tabindex="0" role="combobox" aria-expanded="false" aria-label="Выберите платформу">
                                            <span class="custom-dropdown__placeholder">Выберите платформу</span>
                                            <img src="/icon/chevron-down.svg" alt="Открыть список" class="custom-dropdown__icon">
                                        </div>
                                        <div class="custom-dropdown__menu" role="listbox" aria-hidden="true">
                                            <ul class="custom-dropdown__options">
                                                <li class="custom-dropdown__option" role="option" data-value="Web-Mobile" aria-selected="false">Web-Mobile</li>
                                                <li class="custom-dropdown__option" role="option" data-value="Web-Desktop" aria-selected="false">Web-Desktop</li>
                                                <li class="custom-dropdown__option" role="option" data-value="Desktop" aria-selected="false">Desktop</li>
                                            </ul>
                                        </div>
                                        <div class="selected-platforms-list" id="selected-platforms-list">
                                            @if (Model.GamePlatform != null)
                                            {
                                                <span class="selected-item" data-value="@Model.GamePlatform">
                                                    @Model.GamePlatform
                                                    <span class="selected-item__remove" role="button" aria-label="Удалить @Model.GamePlatform">×</span>
                                                </span>
                                            }
                                        </div>
                                    </div>
                                    <span id="platform-error" class="error-message"></span>
                                </div>
                            </div>

                            @if (Model.GamePlatform == "Desktop")
                            {
                                <div class="upload-form__group" id="game-file-upload-group">
                                    <label class="upload-form__label">Файл игры <span class="required">*</span></label>
                                    @if(Model.GameURL != null)
                                    {
                                        <div class="upload-form__input-wrapper">
                                            <div class="upload-form__file-upload">
                                                <div class="file-upload__previews" id="file-preview"></div>
                                            </div>
                                            <span id="file-error" class="error-message"></span>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="file-upload__file-name">Файл игры отсутствует на сервере!</span>
                                    }
                                </div>
                                <input type="hidden" asp-for="GameURL" />
                            }
                            else
                            {
                                <div class="upload-form__group" id="game-file-url-group">
                                    <label for="game-file-url" class="upload-form__label">
                                        URL-адрес игры <span class="required">*</span>
                                    </label>
                                    <div class="upload-form__input-wrapper">
                                        <div class="input-field">
                                            <input type="url" asp-for="GameURL" id="game-file-url" name="GameURL"
                                                   class="input-field__input" placeholder="Введите URL игры">
                                        </div>
                                        <span id="file-url-error" class="error-message"></span>
                                    </div>
                                </div>
                            }

                            <div class="upload-form__group">
                                <label for="game-cover-url" class="upload-form__label">
                                    Обложка
                                    игры
                                </label>
                                <p class="upload-form__file-label">Прикрепите фото обложки игры</p>
                                <div class="upload-form__file-upload">
                                    <label class="file-upload" id="cover-dropzone">
                                        <div class="file-upload__dropzone">
                                            <div class="file-upload__text">
                                                <img src="/icon/cloud-download.svg" alt="" class="file-upload__icon">
                                                <div class="file-upload__info">
                                                    <p class="file-upload__info-text">
                                                        Загрузите или перетащите файлы
                                                    </p>
                                                    <p class="file-upload__size">Максимальный размер 30MB</p>
                                                </div>
                                            </div>
                                            <input type="file" asp-for="CoverImage" id="game-cover-file"
                                                   class="input-field__input" accept=".jpg,.jpeg,.png,.webp" hidden>
                                        </div>
                                    </label>
                                    <div class="file-upload__previews" id="cover-preview"></div>
                                    <input type="hidden" asp-for="CurrentCoverImagePath" />
                                </div>
                                <span id="cover-error" class="error-message"></span>
                            </div>

                            <div class="upload-form__group">
                                <label for="game-video" class="upload-form__label">
                                    Ссылка на видео из VK
                                </label>
                                <div class="upload-form__input-wrapper">
                                    <div class="input-field">
                                        <input type="url" asp-for="VideoUrl" id="game-video" name="VideoUrl" class="input-field__input"
                                               placeholder="Вставьте URL адрес видео">
                                    </div>
                                    <span id="video-error" class="error-message"></span>
                                </div>
                            </div>

                            <div class="upload-form__group">
                                <p class="upload-form__file-label">Прикрепите скриншоты игры (максимум 3)</p>
                                <div class="upload-form__file-upload">
                                    <label class="file-upload" id="screenshots-dropzone">
                                        <div class="file-upload__dropzone">
                                            <div class="file-upload__text">
                                                <img src="/icon/cloud-download.svg" alt="" class="file-upload__icon">
                                                <div class="file-upload__info">
                                                    <p class="file-upload__info-text">
                                                        Загрузите или перетащите файлы
                                                    </p>
                                                    <p class="file-upload__size">Максимальный размер 30MB</p>
                                                </div>
                                            </div>
                                            <input type="file" asp-for="UploadedImages" name="UploadedImages" id="game-screenshots-file"
                                                   class="input-field__input" accept=".jpg,.jpeg,.png,.webp" multiple
                                                   hidden>
                                        </div>
                                    </label>
                                    <div class="file-upload__previews" id="screenshots-preview">
                                        <!-- Прежние изображения будут добавлены через JS -->
                                    </div>
                                </div>
                                <span id="screenshots-error" class="error-message"></span>
                            </div>

                            <input type="hidden" asp-for="Id" />
                            <input type="hidden" asp-for="AuthorId" />
                            <input type="hidden" asp-for="DispatchDate" />
                            <input type="hidden" asp-for="CurrentGameURL" value="@Model.GameURL" />

                            <button asp-area="Admin" asp-controller="PendingGames" asp-action="#" class="upload-form__submit" aria-busy="false">
                                <span class="upload-form__submit-text">Опубликовать игру</span>
                            </button>
                            <button type="submit" asp-area="Admin" asp-controller="PendingGames" asp-action="Details" class="upload-form__submit" aria-busy="false">
                                <span class="upload-form__submit-text">Сохранить изменения</span>
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <div class="quality-modal__overlay" id="qualityModalOverlay">
                <div class="quality-modal">
                    <button class="quality-modal__close" id="qualityModalClose" aria-label="Закрыть модальное окно">
                        <img src="/icon/close.svg" alt="Закрыть" class="quality-modal__close-icon">
                    </button>
                    <h2 class="quality-modal__title">Рекомендации по обеспечению качества</h2>
                    <div class="quality-modal__section">
                        <h3 class="quality-modal__subtitle">Соответствие осетинской культуре</h3>
                        <p class="quality-modal__text">
                            Убедитесь, что контент игры уважает осетинские традиции.
                            Используйте аутентичные слова, фразы и мотивы.
                        </p>
                    </div>
                    <div class="quality-modal__section">
                        <h3 class="quality-modal__subtitle">Образовательная ценность</h3>
                        <p class="quality-modal__text">
                            Игра должна способствовать изучению языка. Включите задания
                            на словарный запас, грамматику или аудирование.
                        </p>
                    </div>
                    <div class="quality-modal__section">
                        <h3 class="quality-modal__subtitle">Качество метаданных</h3>
                        <p class="quality-modal__text">
                            Укажите точное название, описание и теги. Обложка должна быть
                            привлекательной.
                        </p>
                    </div>
                    <div class="quality-modal__section">
                        <h3 class="quality-modal__subtitle">Техническая интеграция</h3>
                        <p class="quality-modal__text">
                            Используйте HTML5 для встраивания через iframe. Проверьте
                            игру на отсутствие ошибок.
                        </p>
                    </div>
                    <div class="quality-modal__section">
                        <h3 class="quality-modal__subtitle">Доступность и интерактивность</h3>
                        <p class="quality-modal__text">
                            Обеспечьте адаптивность для всех устройств и мгновенную
                            обратную связь.
                        </p>
                    </div>
                    <div class="quality-modal__section">
                        <h3 class="quality-modal__subtitle">Соответствие стандартам</h3>
                        <p class="quality-modal__text">
                            Проверьте игру на соответствие WCAG и безопасность контента.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div id="footer-placeholder"></div>
</div>
<div class="notification" id="notification" aria-live="assertive"></div>

<script type="module" src="js/upload.js"></script>
<script type="module" src="js/script.js"></script>

@* Илона, я честно не смог вынести это в файл отдельный - Upload.js *@
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('game-cover-file');
        const previewContainer = document.getElementById('cover-preview');

        // Если у модели уже есть изображение, показываем его
        const modelImagePath = '@Model?.CurrentCoverImagePath';
        const modelImageInfo = {
            name: '@Model?.CoverImageInfo?.Name',
            size: @(Model?.CoverImageInfo?.Length / 1024 ?? 0)
        };

        if (modelImagePath) {
            showPreview(modelImagePath, modelImageInfo);
        }

        // Обработка выбора нового файла
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const fileInfo = {
                        name: file.name,
                        size: Math.round(file.size / 1024)
                    };
                    showPreview(event.target.result, fileInfo);
                };
                reader.readAsDataURL(file);
            }
        });

        // Функция для отображения превью
        function showPreview(imageSrc, fileInfo) {
            previewContainer.innerHTML = `
                <div class="file-upload__file">
                    <span class="file-upload__file-name">${fileInfo.name}</span>
                    <span class="file-upload__file-size">${fileInfo.size} Кб</span>
                    <img src="/icon/trash.svg" alt="Удалить файл" class="file-upload__file-trash" role="button" aria-label="Удалить ${fileInfo.name}">
                </div>
                <img src="${imageSrc}" class="file-upload__preview-image" alt="Превью обложки игры">
            `;

            // Добавляем обработчик для кнопки удаления
            const deleteButton = previewContainer.querySelector('.file-upload__file-trash');
            deleteButton.addEventListener('click', function() {
                previewContainer.innerHTML = '';
                fileInput.value = '';
            });
        }
    });


    //Для скриншотов игры
    document.addEventListener('DOMContentLoaded', function() {
        const MAX_IMAGES = 3;
        const fileInput = document.getElementById('game-screenshots-file');
        const previewContainer = document.getElementById('screenshots-preview');
        const errorElement = document.getElementById('screenshots-error');
        const form = document.querySelector('form');

        let currentImages = []; // Все текущие изображения (новые + существующие)
        let originalImages = []; // Исходные существующие изображения

        // 1. Инициализация существующих изображений
        @if (Model?.ImagesFilesInfo != null)
        {
                        @foreach (var imgInfo in Model.ImagesFilesInfo)
                        {
                                        <text>
                                        originalImages.push('@imgInfo.FileInfo.Name');
                                        currentImages.push({
                                            type: 'existing',
                                            id: '@imgInfo.FileInfo.Name',
                                            name: '@imgInfo.FileInfo.Name',
                                            path: '@imgInfo.ImagePath'
                                        });
                                        </text>
                        }
        }
        renderPreviews();

        // 2. Обработка новых файлов
        fileInput.addEventListener('change', function(e) {
            errorElement.textContent = '';
            const files = Array.from(e.target.files);

            // Проверка лимита
            if (currentImages.length + files.length > MAX_IMAGES) {
                errorElement.textContent = `Максимум можно загрузить ${MAX_IMAGES} изображения`;
                fileInput.value = '';
                return;
            }

            files.forEach(file => {
                if (!file.type.match('image.*')) {
                    errorElement.textContent = 'Пожалуйста, загружайте только изображения';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    currentImages.push({
                        type: 'new',
                        file: file,
                        name: file.name,
                        preview: event.target.result
                    });
                    renderPreviews();
                };
                reader.readAsDataURL(file);
            });

            fileInput.value = '';
        });

        // 3. Функция отрисовки превью
        function renderPreviews() {
            previewContainer.innerHTML = '';

            // Обновляем статус кнопки загрузки
            fileInput.disabled = currentImages.length >= MAX_IMAGES;

            currentImages.forEach((img, index) => {
                const previewElement = document.createElement('div');
                previewElement.className = 'preview-item';
                previewElement.innerHTML = `
                    <div class="file-upload__file">
                        <span class="file-upload__file-name">${img.name}</span>
                        <img src="/icon/trash.svg" class="file-upload__file-trash"
                             alt="Удалить" title="Удалить">
                    </div>
                    <img src="${img.type === 'existing' ? img.path : img.preview}"
                         class="file-upload__preview-image">
                `;

                // Обработчик удаления
                previewElement.querySelector('.file-upload__file-trash').addEventListener('click', () => {
                    currentImages.splice(index, 1);
                    renderPreviews();
                });

                previewContainer.appendChild(previewElement);
            });
        }

        // 4. Подготовка данных перед отправкой
        form.addEventListener('submit', function(e) {
            // С этой строкой не работает отправка формы из-за конфликта с другим скриптом
            // Обработчиком отправки в upload.js
            // e.preventDefault();

            // Собираем удаленные изображения
            const deletedImages = originalImages.filter(original =>
                !currentImages.some(img => img.type === 'existing' && img.id === original)
            );

            // Добавляем скрытые поля для удаленных изображений
            addHiddenInputs('DeletedImages', deletedImages);

            // Создаем FormData и добавляем файлы
            const formData = new FormData(form);

            // Добавляем новые файлы в FormData
            const newFiles = currentImages
                .filter(img => img.type === 'new')
                .map(img => img.file);

            // Очищаем существующие файлы в FormData
            formData.delete('UploadedImages');

            // Добавляем каждый новый файл отдельно
            newFiles.forEach((file, index) => {
                formData.append(`UploadedImages`, file);
            });
        });

        function addHiddenInputs(name, values) {
            // Удаляем старые inputs
            document.querySelectorAll(`input[name^="${name}"]`).forEach(el => el.remove());

            // Добавляем новые
            values.forEach((value, index) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `${name}[${index}]`;
                input.value = value;
                form.appendChild(input);
            });
        }
    });


    // Для файла игры
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('game-cover-file');
        const previewContainer = document.getElementById('file-preview');
        const gameUrlHiddenInput = document.querySelector('input[name="GameURL"]');

        // Если у модели уже есть файл игры, показываем его
        const modelGameFilePath = '@Model?.GameURL';
        const modelGameFileInfo = {
            name: '@Model?.GameFileInfo?.Name',
            size: @(Model?.GameFileInfo?.Length / (1024 * 1024) ?? 0)
        };

        if (modelGameFilePath) {
            showPreview(modelGameFilePath, modelGameFileInfo);
        }

        // Обработка выбора нового файла
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const fileInfo = {
                        name: file.name,
                        size: Math.round(file.size / (1024 * 1024))
                    };
                    showPreview(event.target.result, fileInfo);
                };
                reader.readAsDataURL(file);
            }
        });

        // Функция для отображения превью
        function showPreview(gameUrl, fileInfo) {
            previewContainer.innerHTML = `
            <div class="file-upload__file">
                 <a href="${gameUrl}" download class="file-upload__file-name">${fileInfo.name}</a>
                 <span class="file-upload__file-size">${fileInfo.size} Мб</span>
                 <img src="/icon/trash.svg" alt="Удалить файл" class="file-upload__file-trash" role="button" aria-label="Удалить ${fileInfo.name}">
            </div>
            `;
            // Добавляем обработчик для кнопки удаления
            const deleteButton = previewContainer.querySelector('.file-upload__file-trash');
            deleteButton.addEventListener('click', function() {
                // Очищаем скрытое поле
                if (gameUrlHiddenInput) {
                    gameUrlHiddenInput.value = '';
                }
                previewContainer.innerHTML = '';
                fileInput.value = '';
            });
        }
    });
</script>